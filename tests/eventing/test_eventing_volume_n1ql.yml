-
  include: tests/templates/kv.yml, tests/templates/vegeta.yml, tests/templates/rebalance.yml, tests/templates/n1ql.yml

####### create index for different buckets for validation #####
- image: sequoiatools/cbq
  command: "-e=http://{{.QueryNodePort}}  -u={{.RestUsername}} -p={{.RestPassword}} -script='create index default_rating on `{{.Bucket}}`(rating) using GSI with {\"num_replica\":2}'"
  wait: true

############### data loading ################
-
  image: sequoiatools/gideon
  requires:  "{{eq true .DoOnce}}"
  command: "kv --ops {{.Scale 1000000}} --create 100 --sizes 64 128 --hosts {{.Orchestrator}} --bucket {{.Bucket}}"
  duration: 300

-
  image: sequoiatools/cmd
  entrypoint: sleep
  command: "600"
  wait: true


############### create and deploy functions ################
-
  image: sequoiatools/eventing
  command: "/eventing.py {{.Nodes | .Service `eventing` | net 0}} {{.RestPort}} alice/n1ql_op.json {{.RestUsername}} {{.RestPassword}} create_and_deploy"
  wait: true
-
  command: "/eventing.py {{.Nodes | .Service `eventing` | net 0}} {{.RestPort}} alice/n1ql_op2.json {{.RestUsername}} {{.RestPassword}} create_and_deploy"
  wait: true
-
  command: "/eventing.py {{.Nodes | .Service `eventing` | net 0}} {{.RestPort}} alice/n1ql_op_timer.json {{.RestUsername}} {{.RestPassword}} create_and_deploy"
  wait: true
-
  command: "/eventing.py {{.Nodes | .Service `eventing` | net 0}} {{.RestPort}} alice/n1ql_op_timer2.json {{.RestUsername}} {{.RestPassword}} create_and_deploy"
  wait: true

###############  Rebalance-in multiple eventing nodes################
- template: add_node
  args: "{{.NthInActiveNode 0}}, eventing"
  wait: true

-
  template: rebalance
  wait: true

-
  image: sequoiatools/cmd
  entrypoint: sleep
  command: "10"
  wait: true

###############  Rebalance-out multiple eventing nodes ################
- template: rebalance_out
  args: "{{.ActiveEventingNode 1}}"
  wait: true

-
  image: sequoiatools/cmd
  entrypoint: sleep
  command: "10"
  wait: true

###############  Swap Rebalance ################
- template: rebalance_swap
  args: "{{.NthInActiveNode 0}},{{.ActiveEventingNode 1}}, eventing"
  wait: true

-
  image: sequoiatools/cmd
  entrypoint: sleep
  command: "1800"
  wait: true

############### validate eventing results ################
-
  image: sequoiatools/eventing
  command: "/eventing_validator.py {{.Orchestrator}} {{.RestUsername}} {{.RestPassword}} {{.Bucket}} {{.NthBucket 1}} 4800 60 True"
  wait: true
-
  command: "/eventing_validator.py {{.Orchestrator}} {{.RestUsername}} {{.RestPassword}} {{.Bucket}} {{.NthBucket 2}} 4800 60 True"
  wait: true
-
  command: "/eventing_validator.py {{.Orchestrator}} {{.RestUsername}} {{.RestPassword}} {{.Bucket}} {{.NthBucket 3}} 4800 60 True"
  wait: true
-
  command: "/eventing_validator.py {{.Orchestrator}} {{.RestUsername}} {{.RestPassword}} {{.Bucket}} {{.NthBucket 4}} 4800 60 True"
  wait: true


